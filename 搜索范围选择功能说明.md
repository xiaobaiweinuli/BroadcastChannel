# 搜索范围选择功能说明

## 功能描述

在频道页面浏览时，用户可以选择搜索范围：
- **搜索所有频道**（默认）
- **仅搜索当前频道**

## 功能特点

### 1. 智能显示
- 在频道页面显示搜索范围选项
- 在搜索结果页显示搜索范围选项（保持搜索上下文）
- 主页和其他页面不显示（因为没有"当前频道"的概念）
- 在消息详情页不显示

### 2. 用户偏好记忆
- 使用 localStorage 保存用户的选择
- 下次访问频道时自动恢复上次的选择
- 在搜索结果页自动识别当前搜索范围并勾选复选框
- 跨频道保持一致的偏好

### 3. 搜索结果
- 显示搜索范围信息
- 页面标题包含频道名称（如果是频道搜索）

## 使用场景

### 场景 1：在频道页面搜索

1. 访问 `/channels/CopyRightZGQInc`
2. 看到搜索框下方有"仅搜索当前频道"选项
3. 勾选该选项
4. 输入搜索关键词，按回车
5. 只显示该频道中匹配的结果

### 场景 2：搜索所有频道

1. 访问 `/channels/CopyRightZGQInc`
2. 不勾选"仅搜索当前频道"选项（或取消勾选）
3. 输入搜索关键词，按回车
4. 显示所有频道中匹配的结果

### 场景 3：标签搜索

1. 在频道页面点击某个标签
2. 如果之前勾选了"仅搜索当前频道"
3. 只显示该频道中带有该标签的消息

## 技术实现

### 1. 前端部分

#### HTML 结构
```astro
<!-- 搜索表单 -->
<form class="search-form" action="/search" method="get" id="search-form">
  <input type="text" name="q" placeholder="Search" id="search-input" />
  <input type="hidden" name="channel" value="" id="search-channel" />
</form>

<!-- 搜索范围选择（在频道页面和搜索结果页显示） -->
{CHANNELS && (pathname.startsWith('/channels/') || pathname.startsWith('/search/')) && !pathname.includes('/posts/') && (
  <div class="search-scope">
    <label class="search-scope-label">
      <input type="checkbox" id="search-current-channel" />
      <span>仅搜索当前频道</span>
    </label>
  </div>
)}
```

#### JavaScript 逻辑
```javascript
// 从URL路径提取当前频道名
const getCurrentChannel = () => {
  const pathname = window.location.pathname
  const match = pathname.match(/^\/channels\/([^\/]+)/)
  return match ? match[1] : null
}

// 从URL参数中获取频道名
const getChannelFromUrl = () => {
  const params = new URLSearchParams(window.location.search)
  return params.get('channel') || null
}

// 表单提交时设置channel参数
searchForm.addEventListener('submit', (e) => {
  // 优先使用URL中的频道参数（搜索结果页），其次使用当前频道（频道页）
  const channelFromUrl = getChannelFromUrl()
  const currentChannel = getCurrentChannel()
  const targetChannel = channelFromUrl || currentChannel
  
  if (searchCurrentChannelCheckbox.checked && targetChannel) {
    searchChannelInput.value = targetChannel
  } else {
    searchChannelInput.value = ''
  }
})

// 初始化复选框状态
const initCheckboxState = () => {
  const channelFromUrl = getChannelFromUrl()
  const currentChannel = getCurrentChannel()
  
  // 如果URL中有channel参数，说明正在进行频道搜索
  if (channelFromUrl) {
    searchCurrentChannelCheckbox.checked = true
    localStorage.setItem('search-current-channel-preference', 'true')
  }
  // 如果在频道页面，从localStorage恢复用户偏好
  else if (currentChannel) {
    const savedPreference = localStorage.getItem('search-current-channel-preference')
    if (savedPreference === 'true') {
      searchCurrentChannelCheckbox.checked = true
    }
  }
}

// 保存用户偏好
searchCurrentChannelCheckbox.addEventListener('change', () => {
  localStorage.setItem('search-current-channel-preference', searchCurrentChannelCheckbox.checked.toString())
})
```

### 2. 后端部分

#### 搜索重定向页面 (src/pages/search/index.astro)
```astro
const q = Astro.url.searchParams.get('q') || ''
const channel = Astro.url.searchParams.get('channel') || ''

if (q) {
  // 保留channel参数
  const searchUrl = `/search/${encodeURIComponent(q)}${channel ? `?channel=${encodeURIComponent(channel)}` : ''}`
  return Astro.redirect(searchUrl)
}
```

#### 搜索结果页面 (src/pages/search/[q].astro)
```astro
const channelParam = Astro.url.searchParams.get('channel') || ''

// 如果提供了channel参数，只搜索该频道
const channel = await getChannelInfo(Astro, {
  q,
  singleChannel: channelParam || undefined,
})
```

#### 标签搜索页面 (src/pages/search/tag/[tag].astro)
```astro
const channelParam = Astro.url.searchParams.get('channel') || ''

const channel = await getChannelInfo(Astro, {
  q: `#${tagName}`,
  singleChannel: channelParam || undefined,
})
```

## URL 格式

### 搜索所有频道
```
/search/关键词?q=关键词
/search/tag/标签名
```

### 搜索指定频道
```
/search/关键词?q=关键词&channel=CopyRightZGQInc
/search/tag/标签名?channel=CopyRightZGQInc
```

## 样式设计

### 视觉效果
- 复选框使用系统原生样式
- 使用主题色（`--highlight-color`）作为选中颜色
- 文字使用次要颜色（`--secondary-color`）
- 鼠标悬停时文字变为主色调

### 响应式
- 在侧边栏中显示
- 自动适配移动端

## 修改的文件

### 新增样式
- `src/assets/style.css` - 添加 `.search-scope` 相关样式

### 修改文件
1. `src/layouts/base.astro`
   - 在频道页面和搜索结果页显示搜索范围选择 UI
   - 添加 JavaScript 处理逻辑（支持从URL参数读取频道）
   - 添加隐藏的 channel 参数

2. `src/pages/search/index.astro`
   - 重定向时保留 channel 参数

3. `src/pages/search/[q].astro`
   - 支持 channel 参数
   - 根据参数决定搜索范围

4. `src/pages/search/tag/[tag].astro`
   - 支持 channel 参数
   - 根据参数决定搜索范围

## 用户体验优化

### 1. 智能默认值
- 默认搜索所有频道（更全面）
- 用户可以根据需要切换到当前频道

### 2. 偏好记忆
- 记住用户的选择
- 下次访问时自动应用

### 3. 清晰反馈
- 搜索结果页面标题显示搜索范围
- 例如："Search: 关键词 in 频道名"

### 4. 灵活切换
- 可以随时勾选或取消勾选
- 立即生效，无需额外操作

## 测试建议

### 1. 基本功能测试
1. 访问频道页面，确认显示搜索范围选项
2. 访问主页，确认不显示搜索范围选项
3. 勾选"仅搜索当前频道"，搜索关键词
4. 确认只显示当前频道的结果

### 2. 偏好记忆测试
1. 勾选"仅搜索当前频道"
2. 刷新页面
3. 确认选项仍然被勾选

### 3. 跨频道测试
1. 在频道A勾选"仅搜索当前频道"
2. 切换到频道B
3. 确认选项仍然被勾选
4. 搜索时只搜索频道B

### 4. 标签搜索测试
1. 在频道页面勾选"仅搜索当前频道"
2. 点击某个标签
3. 确认只显示当前频道的标签结果

### 5. URL 参数测试
1. 直接访问 `/search/test?channel=CopyRightZGQInc`
2. 确认只显示该频道的搜索结果
3. 页面标题包含频道名称

## 注意事项

1. **频道验证**：系统会验证 channel 参数是否在配置的频道列表中
2. **缓存机制**：频道搜索结果独立缓存
3. **SEO**：搜索结果页面已设置 noindex
4. **兼容性**：使用 localStorage，支持所有现代浏览器

## 未来改进建议

1. **高级搜索**：添加更多搜索选项（日期范围、消息类型等）
2. **搜索历史**：记录用户的搜索历史
3. **搜索建议**：输入时显示搜索建议
4. **快捷键**：支持键盘快捷键（如 Ctrl+K 打开搜索）

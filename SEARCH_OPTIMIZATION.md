# 搜索功能优化说明

## 优化内容

### 1. 全量搜索机制
- **一次性获取所有消息**：直接访问 `https://t.me/s/channel` 获取频道的所有消息
- **速度快**：单次请求即可获取所有数据，无需多次分页请求
- **覆盖全面**：搜索频道内的所有可见消息

### 2. 智能缓存策略
- **双层缓存系统**：
  - 基础数据缓存：15秒TTL，50MB容量
  - 搜索结果缓存：5分钟TTL，100MB容量
- 搜索结果会被缓存，相同的搜索查询会直接返回缓存结果
- 避免重复请求，提升响应速度

### 3. 并行搜索
- 多频道搜索时采用并行处理，提高搜索速度
- 每个频道一次请求获取所有数据，然后合并排序

### 4. 用户界面改进
- 显示搜索统计信息（搜索了多少条消息，找到多少结果）
- 搜索关键词高亮显示
- 清晰的搜索结果提示

## 使用方法

### 基本搜索
```
/search/关键词
```
搜索频道内所有消息

### 指定频道搜索
```
/search/关键词?channel=频道名
```
仅在指定频道中搜索

### 标签搜索
```
/search/tag/标签名
```
搜索包含特定标签的消息

### 组合使用
```
/search/关键词?channel=频道名
```
在指定频道中搜索所有消息

## 性能优化

1. **单次请求**：
   - 每个频道只需一次HTTP请求
   - 直接从 `/s/channel` 页面获取所有消息
   - 响应时间通常在几秒内

2. **缓存时效**：
   - 搜索结果缓存5分钟，减少重复搜索的开销
   - 基础数据缓存15秒，保持数据新鲜度

3. **并行处理**：
   - 多频道搜索采用Promise.all并行处理
   - 显著提升多频道搜索速度

4. **内存优化**：
   - LRU缓存自动淘汰最少使用的数据
   - 限制缓存大小，避免内存溢出

## 技术实现

### 核心函数

1. **searchInChannel**：频道搜索函数
   - 单次请求获取频道所有消息
   - 并行处理多个频道
   - 自动合并和排序结果

2. **fetchSingleChannel**：获取频道数据
   - 访问 `https://t.me/s/channel` 获取完整页面
   - 使用cheerio解析HTML，提取所有消息
   - 不使用分页参数，一次性获取所有数据

3. **filterAndHighlightPosts**：过滤和高亮函数
   - 支持关键词搜索和标签搜索
   - 自动高亮匹配的文本
   - 大小写不敏感

### 缓存策略

使用LRU缓存，自动淘汰最少使用的数据：
- 基于查询参数生成缓存键
- 搜索结果独立缓存，避免影响基础数据缓存
- 缓存命中时直接返回，无需重新请求

## 性能对比

### 优化前（分页搜索）
- 需要多次请求（例如64次）
- 总耗时：150秒+
- 每次请求约20条消息

### 优化后（全量搜索）
- 只需1次请求
- 总耗时：10-15秒
- 一次获取所有消息（1000+条）

## 注意事项

1. 搜索结果会被缓存5分钟，如需最新数据请等待缓存过期
2. Telegram的 `/s/channel` 页面可能不包含所有历史消息，只显示最近的消息
3. 对于消息量特别大的频道，首次搜索可能需要较长时间解析HTML

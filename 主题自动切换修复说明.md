# 主题自动切换修复说明

## 问题描述

网页没有自动检测并应用用户系统的主题设置（深色/浅色模式）。即使浏览器设置为深色模式，网页仍然显示浅色主题。

## 问题原因

### 1. HTML 硬编码主题

```html
<html lang="en" data-theme="light">
```

HTML 标签上硬编码了 `data-theme="light"`，导致页面初始加载时总是显示浅色模式。

### 2. JavaScript 执行时机

主题检测的 JavaScript 代码在页面底部执行，会导致：
- 页面先以浅色模式渲染
- JavaScript 执行后才切换到深色模式
- 产生明显的闪烁效果（FOUC - Flash of Unstyled Content）

## 解决方案

### 在 `<head>` 中添加立即执行的脚本

在 HTML 加载的最早阶段就检测并设置主题，避免闪烁：

```html
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script is:inline>
      // 立即执行，避免闪烁
      ;(() => {
        const STORAGE_KEY = 'bc-theme-preference'
        const stored = localStorage.getItem(STORAGE_KEY)
        if (stored) {
          // 优先使用用户手动设置的主题
          document.documentElement.dataset.theme = stored
        }
        else {
          // 自动检测系统主题和时间
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
          const hour = new Date().getHours()
          const shouldUseDark = prefersDark || hour >= 19 || hour < 6
          document.documentElement.dataset.theme = shouldUseDark ? 'dark' : 'light'
        }
      })()
    </script>
  </head>
</html>
```

## 主题检测逻辑

### 优先级

1. **用户手动设置** - 如果用户点击过主题切换按钮，使用保存的偏好
2. **系统主题** - 检测 `prefers-color-scheme: dark` 媒体查询
3. **时间判断** - 晚上7点到早上6点自动使用深色模式

### 检测条件

使用深色模式的条件（满足任一即可）：
- 系统设置为深色模式
- 当前时间在 19:00 - 06:00 之间

## 修改的文件

### src/layouts/base.astro

1. **移除硬编码的主题**
   ```html
   <!-- 修改前 -->
   <html lang="en" data-theme="light">
   
   <!-- 修改后 -->
   <html lang="en">
   ```

2. **添加立即执行的主题检测脚本**
   - 放在 `<head>` 中
   - 使用 `is:inline` 确保立即执行
   - 在任何 CSS 加载前设置主题

## 效果

### 修复前
1. 页面加载时显示浅色模式
2. JavaScript 执行后切换到深色模式
3. 产生明显的闪烁

### 修复后
1. 页面加载时立即检测系统主题
2. 直接以正确的主题渲染
3. 无闪烁，体验流畅

## 测试建议

### 1. 测试系统主题检测

**Windows**:
1. 设置 → 个性化 → 颜色 → 选择模式
2. 切换到"深色"
3. 刷新网页，应该立即显示深色模式

**macOS**:
1. 系统偏好设置 → 通用 → 外观
2. 选择"深色"
3. 刷新网页，应该立即显示深色模式

### 2. 测试时间自动切换

1. 修改系统时间到晚上8点
2. 刷新网页，应该显示深色模式
3. 修改系统时间到上午10点
4. 刷新网页，应该显示浅色模式

### 3. 测试手动切换

1. 点击主题切换按钮
2. 刷新页面，应该保持手动设置的主题
3. 右键点击主题按钮（或双击）恢复自动模式
4. 刷新页面，应该根据系统设置显示主题

### 4. 测试浏览器开发者工具

1. 打开浏览器开发者工具（F12）
2. 找到"渲染"或"Rendering"选项卡
3. 找到"模拟 CSS 媒体功能 prefers-color-scheme"
4. 切换到"prefers-color-scheme: dark"
5. 刷新页面，应该显示深色模式

## 注意事项

1. **清除缓存**: 如果修改后没有生效，尝试清除浏览器缓存
2. **localStorage**: 如果之前手动设置过主题，需要右键点击主题按钮恢复自动模式
3. **浏览器兼容性**: `prefers-color-scheme` 支持所有现代浏览器

## 相关功能

- **手动切换**: 点击主题按钮可以手动切换深色/浅色模式
- **恢复自动**: 右键点击或双击主题按钮可以恢复自动模式
- **实时监听**: 系统主题改变时会自动更新（如果没有手动设置）
- **定时检查**: 每分钟检查一次时间，自动切换主题

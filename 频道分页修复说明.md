# 频道分页修复说明

## 问题描述

在浏览特定频道时（如 `/channels/CopyRightZGQInc`），点击 "Before" 或 "After" 按钮会跳转到主页的分页链接（如 `/before/1716`），而不是该频道的分页链接。

## 问题原因

1. **分页链接硬编码**：`list.astro` 组件中的分页链接硬编码为 `/before/{id}` 和 `/after/{id}`
2. **缺少频道分页路由**：没有为频道页面创建专门的分页路由

## 解决方案

### 1. 修改 list.astro 组件

添加 `baseUrl` 参数和自动检测当前路径的逻辑：

```astro
---
// 添加 baseUrl 参数
const { channel, before = true, after = true, isItem = false, searchQuery = '', baseUrl = '' } = Astro.props

// 自动确定分页基础URL
const paginationBase = baseUrl || Astro.url.pathname.replace(/\/(before|after)\/\d+$/, '')
---

<div class="pages-container">
  {before && beforeCursor > 1 ? (
    <a href={`${paginationBase}/before/${beforeCursor}`} title="Before" class="page">
      Before
    </a>
  ) : (
    <span class="page-placeholder">&nbsp;</span>
  )}

  <div class="pages-info"></div>
  
  {after && afterCursor ? (
    <a href={`${paginationBase}/after/${afterCursor}`} title="After" class="page">
      After
    </a>
  ) : (
    <span class="page-placeholder">&nbsp;</span>
  )}
</div>
```

### 2. 创建频道分页路由

#### src/pages/channels/[channel]/before/[cursor].astro

```astro
---
import List from '../../../../components/list.astro'
import { getChannelInfo } from '../../../../lib/telegram'
import { getEnv } from '../../../../lib/env'

const { channel: channelName, cursor } = Astro.params

// 验证频道是否存在
const channelsEnv = getEnv(import.meta.env, Astro, 'CHANNELS')
const channels = channelsEnv
  ? channelsEnv.split(',').map((c) => c.trim()).filter(Boolean)
  : []

if (!channels.includes(channelName)) {
  return Astro.redirect('/channels')
}

// 获取频道数据（带分页）
const channel = await getChannelInfo(Astro, {
  singleChannel: channelName,
  before: cursor,
})

channel.seo = {
  title: channel.title,
  noindex: true,
}
---

<List channel={channel} baseUrl={`/channels/${channelName}`} />
```

#### src/pages/channels/[channel]/after/[cursor].astro

类似的实现，使用 `after` 参数。

## 路由结构

### 主页分页
- `/` - 主页
- `/before/{id}` - 主页的前一页
- `/after/{id}` - 主页的后一页

### 频道分页
- `/channels/{channel}` - 频道首页
- `/channels/{channel}/before/{id}` - 频道的前一页
- `/channels/{channel}/after/{id}` - 频道的后一页

## 分页逻辑

### baseUrl 参数

- **显式传递**：在频道页面中传递 `baseUrl={'/channels/${channelName}'}`
- **自动检测**：如果没有传递 baseUrl，从当前 URL 中提取（去除 `/before/{id}` 或 `/after/{id}` 部分）

### 示例

#### 频道页面
```
当前URL: /channels/CopyRightZGQInc
点击 Before: /channels/CopyRightZGQInc/before/1716
点击 After: /channels/CopyRightZGQInc/after/1800
```

#### 主页
```
当前URL: /
点击 Before: /before/1716
点击 After: /after/1800
```

#### 分页页面
```
当前URL: /channels/CopyRightZGQInc/before/1716
点击 Before: /channels/CopyRightZGQInc/before/1650
点击 After: /channels/CopyRightZGQInc/after/1716
```

## 修改的文件

### 新增文件
1. `src/pages/channels/[channel]/before/[cursor].astro` - 频道前一页路由
2. `src/pages/channels/[channel]/after/[cursor].astro` - 频道后一页路由

### 修改文件
1. `src/components/list.astro` - 添加 baseUrl 参数和自动检测逻辑

## 测试建议

### 1. 测试频道分页
1. 访问 `/channels/CopyRightZGQInc`
2. 点击 "Before" 按钮
3. 确认跳转到 `/channels/CopyRightZGQInc/before/{id}`
4. 确认显示的是该频道的内容
5. 继续点击 "Before" 或 "After"，确认分页正常

### 2. 测试主页分页
1. 访问主页 `/`
2. 点击 "Before" 按钮
3. 确认跳转到 `/before/{id}`
4. 确认显示的是主页的内容

### 3. 测试频道验证
1. 尝试访问不存在的频道分页：`/channels/invalid_channel/before/123`
2. 确认重定向到 `/channels`

### 4. 测试多个频道
1. 访问不同的频道
2. 确认每个频道的分页都是独立的
3. 确认不会混淆不同频道的内容

## 注意事项

1. **频道验证**：分页路由会验证频道是否在 CHANNELS 配置中
2. **SEO**：分页页面设置了 `noindex: true`，避免搜索引擎索引
3. **缓存**：每个频道的分页数据独立缓存
4. **向后兼容**：主页的分页链接保持不变

## 相关功能

- 频道列表页：`/channels`
- 单个频道页：`/channels/{channel}`
- 频道消息详情：`/posts/{channel}/{id}`
- 频道分页：`/channels/{channel}/before/{id}` 和 `/channels/{channel}/after/{id}`

---
import Layout from '../layouts/base.astro'
import Header from '../components/header.astro'
import Item from '../components/item.astro'

const { SITE_URL } = Astro.locals
const { channel, before = true, after = true, isItem = false, searchQuery = '', baseUrl = '' } = Astro.props
const posts = channel.posts ?? []

const beforeCursor = posts[posts.length - 1]?.id
const afterCursor = posts[0]?.id

// Determine the base URL for pagination
// If baseUrl is provided, use it; otherwise use the current pathname
const paginationBase = baseUrl || Astro.url.pathname.replace(/\/(before|after)\/\d+$/, '')
---

<Layout channel={channel} id="main-container">
  <slot name="header">
    <Header channel={channel} />
  </slot>

  {
    searchQuery && (
      <div class="text-box search-info">
        {posts.length > 0 ? (
          <div>
            <p>
              找到 {posts.length} 条结果
              {channel.searchStats?.totalSearched && (
                <span> (共搜索 {channel.searchStats.totalSearched} 条消息)</span>
              )}
            </p>
          </div>
        ) : (
          <div>
            <p>未找到 "{searchQuery}" 的结果</p>
          </div>
        )}
      </div>
    )
  }

  <div class="items">
    {posts.map((post) => <Item post={post} isItem={isItem} showChannelBadge={channel.isMultiChannel} />)}
  </div>

  <div class="pages-container">
    {
      before && beforeCursor > 1 ? (
        <a href={`${paginationBase}/before/${beforeCursor}`} title="Before" class="page">
          Before
        </a>
      ) : (
        <span class="page-placeholder">&nbsp;</span>
      )
    }

    <div class="pages-info"></div>
    {
      after && afterCursor ? (
        <a href={`${paginationBase}/after/${afterCursor}`} title="After" class="page">
          After
        </a>
      ) : (
        <span class="page-placeholder">&nbsp;</span>
      )
    }
  </div>
</Layout>

<style>
  .search-info {
    color: var(--secondary-color);
    background-color: var(--code-background-color);
    margin-bottom: 1rem;
  }
</style>

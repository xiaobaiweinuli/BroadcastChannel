---
import Layout from '../layouts/base.astro'
import Header from '../components/header.astro'
import { getChannelInfo, getAllTags } from '../lib/telegram'
import { getEnv } from '../lib/env'

const channel = await getChannelInfo(Astro)

channel.seo = {
  title: 'Tags',
}

// Get tags from environment variable or auto-detect from posts
const envTags = getEnv(import.meta.env, Astro, 'TAGS') || ''
let tags = []

if (envTags === 'true' || envTags === 'TRUE') {
  // Auto mode: extract all tags from posts
  tags = await getAllTags(Astro)
} else if (envTags && envTags.length > 0) {
  // Manual mode: use specified tags
  tags = envTags
    .split(',')
    .map((tag) => tag.trim())
    .filter((tag) => tag.length > 0)
} else {
  // No tags configured
  tags = []
}

// Count posts for each tag
const tagCounts = {}
channel.posts?.forEach((post) => {
  if (post.tags && Array.isArray(post.tags)) {
    post.tags.forEach((tag) => {
      tagCounts[tag] = (tagCounts[tag] || 0) + 1
    })
  }
})
---

<Layout channel={channel} id="main-container">
  <slot name="header">
    <Header channel={channel} />
  </slot>

  <div class="section-title">Tags</div>

  {
    tags.length === 0 ? (
      <div class="text-box">
        <p>No tags configured. Set TAGS environment variable to enable tags.</p>
        <p>Use TAGS=true for auto-detection, or TAGS=tag1,tag2,tag3 for specific tags.</p>
      </div>
    ) : (
      <div class="tag-cloud">
        {tags.map((tag: string) => {
          const count = tagCounts[tag] || 0
          return (
            <div class="tag-cloud-item">
              <a href={`/search/tag/${encodeURIComponent(tag)}`} class="tag">
                {tag}
              </a>
              {count > 0 && <span class="tag-cloud-item-count">{count}</span>}
            </div>
          )
        })}
      </div>
    )
  }
</Layout>

---
import '../assets/normalize.css'
import '../assets/style.css'
import '../assets/global.css'
import { SEO } from 'astro-seo'
import { getEnv } from '../lib/env'
import backToTopIcon from '../assets/back-to-top.svg'

const { SITE_URL, RSS_URL, RSS_PREFIX } = Astro.locals
const { channel } = Astro.props

const locale = getEnv(import.meta.env, Astro, 'LOCALE')

const seo = channel?.seo
const reqPathname = Astro.url.pathname.replace(/\/$/, '')
const canonical = SITE_URL.startsWith('http') ? new URL(SITE_URL).origin + reqPathname : Astro.url.origin + reqPathname

const { origin, pathname } = new URL(canonical)
const twitter = getEnv(import.meta.env, Astro, 'TWITTER')

const seoParams = {
  title: seo?.title,
  description: seo?.text ?? channel?.description,
  canonical,
  noindex: seo?.noindex ?? getEnv(import.meta.env, Astro, 'NOINDEX'),
  nofollow: seo?.nofollow ?? getEnv(import.meta.env, Astro, 'NOFOLLOW'),
  openGraph: {
    basic: {
      type: 'website',
      title: channel?.title ?? '',
      url: canonical,
      image: channel?.avatar ? channel.avatar : origin + '/favicon.ico',
    },
    optional: {
      description: seo?.text ?? channel?.description,
      locale,
    },
  },
  extend: {
    link: [
      {
        rel: 'icon',
        href: channel?.avatar
          ? `https://wsrv.nl/?w=64&h=64&fit=cover&mask=circle&url=ssl:${channel?.avatar?.replace(/^https?:\/\//, '')}`
          : '/favicon.svg',
      },
    ],
  },
}

const GOOGLE_SEARCH_SITE = getEnv(import.meta.env, Astro, 'GOOGLE_SEARCH_SITE')
const searchAction = GOOGLE_SEARCH_SITE ? 'https://www.google.com/search' : `${SITE_URL}search`

const HEADER_INJECT = getEnv(import.meta.env, Astro, 'HEADER_INJECT')
const FOOTER_INJECT = getEnv(import.meta.env, Astro, 'FOOTER_INJECT')
const TAGS = getEnv(import.meta.env, Astro, 'TAGS')
const LINKS = getEnv(import.meta.env, Astro, 'LINKS')
const CHANNELS = getEnv(import.meta.env, Astro, 'CHANNELS')

const navs = (getEnv(import.meta.env, Astro, 'NAVS') || '')
  .split(';')
  .filter(Boolean)
  .map((link) => {
    link = link.split(',')
    return {
      title: link[0],
      href: link[1],
    }
  })
---

<!doctype html>
<html lang={locale ?? 'en'}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#f4f1ec" />
    <script is:inline>
      // 立即执行，避免闪烁
      ;(() => {
        const STORAGE_KEY = 'bc-theme-preference'
        const stored = localStorage.getItem(STORAGE_KEY)
        if (stored) {
          document.documentElement.dataset.theme = stored
        }
        else {
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
          const hour = new Date().getHours()
          const shouldUseDark = prefersDark || hour >= 19 || hour < 6
          document.documentElement.dataset.theme = shouldUseDark ? 'dark' : 'light'
        }
      })()
    </script>
    <link rel="alternate" type="application/rss+xml" title={`${RSS_PREFIX}${channel?.title}`} href={RSS_URL} />
    <style is:inline>
      @view-transition {
        navigation: auto; /* enabled */
      }
    </style>
    <SEO
      titleTemplate={`%s | ${channel?.title}`}
      titleDefault={[channel?.title, seoParams.description].filter(Boolean).join(' - ')}
      twitter={{
        card: 'summary_large_image',
        creator: twitter ? `@${twitter}` : undefined,
      }}
      {...seoParams}
    />
    <Fragment set:html={HEADER_INJECT} />
  </head>

  <body>
    <div id="wrapper">
      <div id="container">
        <div id="main-container">
          <slot />
        </div>
        <div id="aside-container">
          <slot name="aside">
            <div class="nav">
              <div class="nav-item">
                <a href={SITE_URL} title={channel?.title} class={`nav-link ${pathname === '/' ? 'current' : ''}`}>
                  Home
                </a>
              </div>
              {
                CHANNELS ? (
                  <div class="nav-item">
                    <a
                      href={`${SITE_URL}channels`}
                      title="Channels"
                      class={`nav-link ${pathname === '/channels' || pathname.startsWith('/channels/') ? 'current' : ''}`}
                    >
                      Channels
                    </a>
                  </div>
                ) : null
              }
              {
                TAGS ? (
                  <div class="nav-item">
                    <a
                      href={`${SITE_URL}tags`}
                      title="Tags"
                      class={`nav-link ${pathname === '/tags' ? 'current' : ''}`}
                    >
                      Tags
                    </a>
                  </div>
                ) : null
              }
              {
                LINKS ? (
                  <div class="nav-item">
                    <a
                      href={`${SITE_URL}links`}
                      title="Links"
                      class={`nav-link ${pathname === '/links' ? 'current' : ''}`}
                    >
                      Links
                    </a>
                  </div>
                ) : null
              }
              {
                navs.map((nav) => (
                  <div class="nav-item">
                    <a href={nav.href} title={nav.title} target="_blank" rel="noopener" class="nav-link">
                      {nav.title}
                    </a>
                  </div>
                ))
              }
            </div>
            <input class="search-icon" name="icon" type="checkbox" placeholder="Search" />
            <form class="search-form" action={searchAction} method="get" id="search-form">
              {GOOGLE_SEARCH_SITE ? <input type="hidden" name="as_sitesearch" value={GOOGLE_SEARCH_SITE} /> : null}
              <input type="text" name="q" placeholder="Search" id="search-input" />
              <input type="hidden" name="channel" value="" id="search-channel" />
            </form>
            {
              CHANNELS && (pathname.startsWith('/channels/') || pathname.startsWith('/search/')) && !pathname.includes('/posts/') && (
                <div class="search-scope">
                  <label class="search-scope-label">
                    <input type="checkbox" id="search-current-channel" />
                    <span>仅搜索当前频道</span>
                  </label>
                </div>
              )
            }
            <div class="copyright-wrap">
              Powered by
              <a
                href="https://github.com/ccbikai/BroadcastChannel"
                title="BroadcastChannel"
                target="_blank"
                rel="noopener"
              >
                BroadcastChannel
              </a> &
              <a href="https://github.com/Planetable/SiteTemplateSepia" title="Sepia" target="_blank" rel="noopener">
                Sepia
              </a>
            </div>
          </slot>
        </div>
      </div>
    </div>
    <a href="#wrapper" id="back-to-top" aria-label="Back to top">
      <img {...backToTopIcon} alt="Back to Top" />
    </a>
    <Fragment set:html={FOOTER_INJECT} />
    <script is:inline>
      ;(() => {
        if (typeof window === 'undefined') 
return
        if (document.getElementById('image-preview-overlay')) 
return

        const overlay = document.createElement('div')
        overlay.id = 'image-preview-overlay'
        overlay.setAttribute('aria-hidden', 'true')
        overlay.innerHTML = `
          <div class="preview-backdrop" data-preview-close></div>
          <div class="preview-content" role="dialog" aria-modal="true">
            <div class="preview-nav-wrapper prev-wrapper">
              <button type="button" class="preview-nav prev" aria-label="Previous image">&lsaquo;</button>
            </div>
            <div class="preview-image-wrapper">
              <img src="" alt="" />
              <button type="button" class="preview-close" aria-label="Close image preview" data-preview-close>&times;</button>
            </div>
            <div class="preview-nav-wrapper next-wrapper">
              <button type="button" class="preview-nav next" aria-label="Next image">&rsaquo;</button>
            </div>
          </div>
        `
        document.body.appendChild(overlay)

        const imgEl = overlay.querySelector('img')
        const prevBtn = overlay.querySelector('.preview-nav.prev')
        const nextBtn = overlay.querySelector('.preview-nav.next')
        const closeTargets = overlay.querySelectorAll('[data-preview-close]')

        let images = []
        let index = 0

        const updateView = () => {
          if (!images.length) {
            imgEl.removeAttribute('src')
            overlay.classList.remove('is-visible')
            overlay.setAttribute('aria-hidden', 'true')
            document.body.classList.remove('preview-open')
            return
          }

          imgEl.src = images[index]
          imgEl.alt = `Preview ${index + 1} of ${images.length}`
          overlay.classList.add('is-visible')
          overlay.setAttribute('aria-hidden', 'false')
          document.body.classList.add('preview-open')

          const singleImage = images.length <= 1
          prevBtn.disabled = singleImage
          nextBtn.disabled = singleImage
        }

        const show = (list, startIndex = 0) => {
          if (!Array.isArray(list) || !list.length) 
return
          images = list
          index = Math.min(Math.max(startIndex, 0), images.length - 1)
          updateView()
        }

        const close = () => {
          images = []
          index = 0
          updateView()
        }

        const showPrev = () => {
          if (!images.length) 
return
          index = (index - 1 + images.length) % images.length
          updateView()
        }

        const showNext = () => {
          if (!images.length) 
return
          index = (index + 1) % images.length
          updateView()
        }

        prevBtn.addEventListener('click', (event) => {
          event.stopPropagation()
          showPrev()
        })

        nextBtn.addEventListener('click', (event) => {
          event.stopPropagation()
          showNext()
        })

        closeTargets.forEach((target) => {
          target.addEventListener('click', close)
        })

        document.addEventListener('keydown', (event) => {
          if (!overlay.classList.contains('is-visible')) 
return
          if (event.key === 'Escape') {
            close()
          }
 else if (event.key === 'ArrowLeft') {
            showPrev()
          }
 else if (event.key === 'ArrowRight') {
            showNext()
          }
        })

        document.addEventListener('click', (event) => {
          const button = event.target.closest('.image-preview-button[data-image-index]')
          if (!button) 
return

          const container = button.closest('.image-list-container')
          if (!container) 
return

          const buttons = [...container.querySelectorAll('.image-preview-button[data-image-url]')]
          if (!buttons.length) 
return

          const list = buttons.map((btn) => btn.dataset.imageUrl).filter(Boolean)
          if (!list.length) 
return

          const startIndex = Number(button.dataset.imageIndex) || 0
          show(list, Math.min(startIndex, list.length - 1))
        })
      })()
    </script>
    <script is:inline>
      ;(() => {
        if (typeof window === 'undefined') return

        const STORAGE_KEY = 'bc-theme-preference'
        const root = document.documentElement
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)')
        const toggleButton = document.querySelector('[data-theme-toggle]')
        let autoTimer

        const computeAutoTheme = () => {
          const hour = new Date().getHours()
          const shouldUseDark = prefersDark.matches || hour >= 19 || hour < 6
          return shouldUseDark ? 'dark' : 'light'
        }

        const updateToggleButton = (theme) => {
          if (!toggleButton) return
          toggleButton.dataset.theme = theme
          toggleButton.setAttribute('aria-label', theme === 'dark' ? '切换到浅色模式' : '切换到深色模式')
        }

        const applyTheme = (theme) => {
          root.dataset.theme = theme
          updateToggleButton(theme)
        }

        const syncTheme = () => {
          const stored = localStorage.getItem(STORAGE_KEY)
          if (stored) {
            applyTheme(stored)
            return
          }
          applyTheme(computeAutoTheme())
        }

        const startAutoTimer = () => {
          clearInterval(autoTimer)
          autoTimer = setInterval(() => {
            if (!localStorage.getItem(STORAGE_KEY)) applyTheme(computeAutoTheme())
          }, 60 * 1000)
        }

        syncTheme()
        startAutoTimer()

        prefersDark.addEventListener('change', () => {
          if (!localStorage.getItem(STORAGE_KEY)) syncTheme()
        })

        if (toggleButton) {
          toggleButton.addEventListener('click', () => {
            const stored = localStorage.getItem(STORAGE_KEY)
            const current = stored || root.dataset.theme
            const next = current === 'dark' ? 'light' : 'dark'
            localStorage.setItem(STORAGE_KEY, next)
            applyTheme(next)
          })

          const resetToAuto = () => {
            localStorage.removeItem(STORAGE_KEY)
            syncTheme()
            startAutoTimer()
          }

          toggleButton.addEventListener('contextmenu', (event) => {
            event.preventDefault()
            resetToAuto()
          })

          toggleButton.addEventListener('dblclick', (event) => {
            event.preventDefault()
            resetToAuto()
          })
        }
      })()
    </script>
    <script is:inline>
      // 搜索范围选择
      ;(() => {
        if (typeof window === 'undefined') return

        const searchForm = document.getElementById('search-form')
        const searchInput = document.getElementById('search-input')
        const searchChannelInput = document.getElementById('search-channel')
        const searchCurrentChannelCheckbox = document.getElementById('search-current-channel')

        if (!searchForm || !searchInput || !searchChannelInput) return

        // 从当前URL提取频道名
        const getCurrentChannel = () => {
          const pathname = window.location.pathname
          const match = pathname.match(/^\/channels\/([^\/]+)/)
          return match ? match[1] : null
        }

        // 从URL参数中获取频道名
        const getChannelFromUrl = () => {
          const params = new URLSearchParams(window.location.search)
          return params.get('channel') || null
        }

        // 处理搜索表单提交
        searchForm.addEventListener('submit', (e) => {
          // 优先使用URL中的频道参数（搜索结果页），其次使用当前频道（频道页）
          const channelFromUrl = getChannelFromUrl()
          const currentChannel = getCurrentChannel()
          const targetChannel = channelFromUrl || currentChannel
          
          if (searchCurrentChannelCheckbox && searchCurrentChannelCheckbox.checked && targetChannel) {
            searchChannelInput.value = targetChannel
          }
          else {
            searchChannelInput.value = ''
          }
        })

        // 初始化复选框状态
        if (searchCurrentChannelCheckbox) {
          const initCheckboxState = () => {
            const channelFromUrl = getChannelFromUrl()
            const currentChannel = getCurrentChannel()
            
            // 如果URL中有channel参数，说明正在进行频道搜索
            if (channelFromUrl) {
              searchCurrentChannelCheckbox.checked = true
              localStorage.setItem('search-current-channel-preference', 'true')
            }
            // 如果在频道页面，从localStorage恢复用户偏好
            else if (currentChannel) {
              const savedPreference = localStorage.getItem('search-current-channel-preference')
              if (savedPreference === 'true') {
                searchCurrentChannelCheckbox.checked = true
              }
            }
          }

          initCheckboxState()

          // 保存用户偏好
          searchCurrentChannelCheckbox.addEventListener('change', () => {
            localStorage.setItem('search-current-channel-preference', searchCurrentChannelCheckbox.checked.toString())
          })
        }
      })()
    </script>
  </body>
</html>
